var L=Object.create;var h=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var F=Object.getOwnPropertyNames;var $=Object.getPrototypeOf,M=Object.prototype.hasOwnProperty;var W=(i,e)=>{for(var t in e)h(i,t,{get:e[t],enumerable:!0})},U=(i,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of F(e))!M.call(i,s)&&s!==t&&h(i,s,{get:()=>e[s],enumerable:!(n=T(e,s))||n.enumerable});return i};var x=(i,e,t)=>(t=i!=null?L($(i)):{},U(e||!i||!i.__esModule?h(t,"default",{value:i,enumerable:!0}):t,i)),Q=i=>U(h({},"__esModule",{value:!0}),i);var G={};W(G,{activate:()=>K});module.exports=Q(G);var P=x(require("vscode"));var o=x(require("vscode"));function f(i){for(;i.length;){let e=i.pop();e&&e.dispose()}}var y=class{constructor(){this._isDisposed=!1;this._disposables=[]}dispose(){this._isDisposed||(this._isDisposed=!0,f(this._disposables))}_register(e){return this._isDisposed?e.dispose():this._disposables.push(e),e}get isDisposed(){return this._isDisposed}};var C=class{constructor(){this._webviews=new Set}*get(e){let t=e.toString();for(let n of this._webviews)n.resource===t&&(yield n.webviewPanel)}has(e){return!this.get(e).next().done}add(e,t){let n={resource:e.toString(),webviewPanel:t};this._webviews.add(n),t.onDidDispose(()=>{this._webviews.delete(n)})}};var l=class extends y{constructor(e,t,n){super();this._edits=[];this._savedEdits=[];this.pathRegExp=/(?<dirname>.*)\/(?<filename>(?<basename>.*)(?<extname>\.[^.]+))$/;this._onDidDispose=this._register(new o.EventEmitter);this.onDidDispose=this._onDidDispose.event;this._onDidChangeDocument=this._register(new o.EventEmitter);this.onDidChangeContent=this._onDidChangeDocument.event;this._onDidChange=this._register(new o.EventEmitter);this.onDidChange=this._onDidChange.event;this._uri=e,this._documentData=t,this._delegate=n}static async create(e,t,n){let s=typeof t=="string"?o.Uri.parse(t):e,r=await l.readFile(s);return new l(e,r,n)}static async readFile(e){if(e.scheme==="untitled")return new Uint8Array;let s=(o.workspace.getConfiguration("sqliteViewer").get("maxFileSize")??200)*2**20,r=await o.workspace.fs.stat(e);return s!==0&&r.size>s?null:o.workspace.fs.readFile(e)}get uri(){return this._uri}get uriParts(){let{dirname:e,filename:t,basename:n,extname:s}=this._uri.toString().match(this.pathRegExp)?.groups??{};return{dirname:e,filename:t,basename:n,extname:s}}get documentData(){return this._documentData}dispose(){this._onDidDispose.fire(),super.dispose()}makeEdit(e){this._edits.push(e),this._onDidChange.fire({label:"Stroke",undo:async()=>{this._edits.pop(),this._onDidChangeDocument.fire({edits:this._edits})},redo:async()=>{this._edits.push(e),this._onDidChangeDocument.fire({edits:this._edits})}})}async save(e){await this.saveAs(this.uri,e),this._savedEdits=Array.from(this._edits)}async saveAs(e,t){let n=await this._delegate.getFileData();t.isCancellationRequested||await o.workspace.fs.writeFile(e,n)}async revert(e){let t=await l.readFile(this.uri);this._documentData=t,this._edits=this._savedEdits,t&&this._onDidChangeDocument.fire({content:t,edits:this._edits})}async refresh(e){let t=await l.readFile(this.uri);this._documentData=t,this._edits=[],t&&this._onDidChangeDocument.fire({content:t,edits:[]})}async backup(e,t){return await this.saveAs(e,t),{id:e.toString(),delete:async()=>{try{await o.workspace.fs.delete(e)}catch{}}}}},R="default-src",q="script-src",j="style-src",I="img-src",B="font-src",O="child-src",u="'self'",v="vscode-resource: qwtel.vscode-unpkg.net",H="data:",z="blob:",N="'unsafe-inline'",V="'unsafe-eval'",J=i=>Object.entries(i).map(([e,t])=>`${e} ${t.join(" ")};`).join(" "),_=class{constructor(e){this._context=e;this.webviews=new C;this._onDidChangeCustomDocument=new o.EventEmitter;this.onDidChangeCustomDocument=this._onDidChangeCustomDocument.event;this._requestId=1;this._callbacks=new Map}async openCustomDocument(e,t,n){let s=await l.create(e,t.backupId,{getFileData:async()=>{let a=[...this.webviews.get(s.uri)];if(!a.length)throw new Error("Could not find webview to save for");let c=a[0],d=await this.postMessageWithResponse(c,"getFileData",{});return new Uint8Array(d)}}),r=[];return r.push(s.onDidChange(a=>{this._onDidChangeCustomDocument.fire({document:s,...a})})),r.push(s.onDidChangeContent(a=>{for(let c of this.webviews.get(s.uri)){let{filename:d}=s.uriParts,{buffer:p,byteOffset:g,byteLength:S}=s.documentData||{},A={buffer:p,byteOffset:g,byteLength:S};this.postMessage(c,"update",{filename:d,value:A,editable:!1},[p])}})),s.onDidDispose(()=>f(r)),s}async resolveCustomEditor(e,t,n){this.webviews.add(e.uri,t),t.webview.options={enableScripts:!0},t.webview.html=await this.getHtmlForWebview(t.webview),t.webview.onDidReceiveMessage(s=>this.onMessage(e,s)),t.webview.onDidReceiveMessage(s=>{if(s.type==="ready"&&this.webviews.has(e.uri))if(e.uri.scheme==="untitled")this.postMessage(t,"init",{filename:"untitled",untitled:!0,editable:!1});else{let{buffer:a,byteOffset:c,byteLength:d}=e.documentData||{},p={buffer:a,byteOffset:c,byteLength:d},{filename:g}=e.uriParts;this.postMessage(t,"init",{filename:g,value:p,editable:!1},[a])}})}saveCustomDocument(e,t){return e.save(t)}saveCustomDocumentAs(e,t,n){return e.saveAs(t,n)}revertCustomDocument(e,t){return e.revert(t)}backupCustomDocument(e,t,n){return e.backup(t.destination,n)}async getHtmlForWebview(e){let t=o.Uri.joinPath(this._context.extensionUri,"sqlite-viewer-app","public"),n=o.Uri.joinPath(this._context.extensionUri,"node_modules","@vscode/codicons","dist","codicon.css"),s=new TextDecoder().decode(await o.workspace.fs.readFile(o.Uri.joinPath(t,"vscode.html"))),r=e.asWebviewUri(o.Uri.joinPath(this._context.extensionUri,"sqlite-viewer-app","public")).toString(),a={[R]:[u,v],[q]:[u,v,V],[j]:[u,v,N],[I]:[u,v,H],[B]:[u,v],[O]:[z]};return s.replaceAll("%PUBLIC_URL%",r).replaceAll("%REACT_APP_CSP%",J(a)).replace("<!--HEAD-->",`
        <link rel="stylesheet" href="${e.asWebviewUri(o.Uri.joinPath(t,"bundle.css"))}"/>
        <link rel="stylesheet" href="${e.asWebviewUri(n)}"/>
      `).replace("<!--BODY-->",`
        <script src="${e.asWebviewUri(o.Uri.joinPath(t,"bundle.js"))}"><\/script>
      `)}postMessageWithResponse(e,t,n){let s=this._requestId++,r=new Promise(a=>this._callbacks.set(s,a));return e.webview.postMessage({type:t,requestId:s,body:n}),r}postMessage(e,t,n,s){e.webview.postMessage({type:t,body:n},s)}async onMessage(e,t){switch(t.type){case"refresh":e.uri.scheme!=="untitled"&&e.refresh();return;case"blob":let{data:n,download:s,metaKey:r}=t,{dirname:a}=e.uriParts,c=o.Uri.parse(`${a}/${s}`);await o.workspace.fs.writeFile(c,n),r||await o.commands.executeCommand("vscode.open",c);return;case"response":{this._callbacks.get(t.requestId)?.(t.body);return}}}},E={webviewOptions:{retainContextWhenHidden:!0},supportsMultipleEditorsPerDocument:!1},w=class extends _{static register(e){return o.window.registerCustomEditorProvider(w.viewType,new w(e),E)}},m=w;m.viewType="sqlite-viewer.view";var D=class extends _{static register(e){return o.window.registerCustomEditorProvider(D.viewType,new D(e),E)}},b=D;b.viewType="sqlite-viewer.option";function K(i){Y(i),i.subscriptions.push(m.register(i)),i.subscriptions.push(b.register(i))}var k="qwtel.sqlite-viewer";async function Y(i){let e=i.globalState.get(k),t=P.extensions.getExtension(k).packageJSON.version;i.globalState.update(k,t)}
